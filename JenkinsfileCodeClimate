DOCKER_GROUP = 'cwds'
DOCKER_IMAGE = 'casemanagement'
SLACK_CHANNEL = '#casemanagement-stream'
SLACK_CREDENTIALS_ID = 'slackmessagetpt2'
DOCKER_NAME = 'cm-latest'

def notify(String status) {
    status = status ?: 'SUCCESS'
    def colorCode = status == 'SUCCESS' ? '#00FF00' : '#FF0000'
    def summary = """*${status}*: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':\nMore detail in console output at <${env.BUILD_URL}|${env.BUILD_URL}>"""
    slackSend(
        channel: SLACK_CHANNEL,
        baseUrl: 'https://hooks.slack.com/services/',
        tokenCredentialId: SLACK_CREDENTIALS_ID,
        color: colorCode,
        message: summary
    )
}

pipeline {
    def app
    try {
        stage('Checkout') {
            checkout scm
        }
        stage('Build Docker Image') {
            app = docker.build("${DOCKER_GROUP}/${DOCKER_IMAGE}:${env.BUILD_ID}")
        }
        app.withRun("-e CI=true") { cm ->
            stage('Lint') {
                sh "docker exec -t ${cm.id} yarn lint"
            }
            stage('Unit Test') {
                sh "docker exec -t ${cm.id} bundle exec rspec"
                sh "docker exec -t ${cm.id} yarn run test"
            }
        }
    } catch(Exception e) {
       currentBuild.result = "FAILURE"
       throw e
    } finally {
        notify(currentBuild.result)
        cleanWs()
    }
}
